<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.57.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>python 协程 | Learning Hardy</title>
    <meta property="og:title" content="python 协程 - Learning Hardy">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2017-11-26T00:00:00&#43;08:00">
        
        
    <meta property="article:modified_time" content="2017-11-26T00:00:00&#43;08:00">
        
    <meta name="Keywords" content="">
    <meta name="description" content="python 协程">
        
    <meta name="author" content="">
    <meta property="og:url" content="http://example.org/post/python%E5%8D%8F%E7%A8%8B/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/css/normalize.css">
    
        <link rel="stylesheet" href="/css/prism.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://example.org/">
                        Learning Hardy
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://example.org/">首页</a>
                    
                    <a  href="http://example.org/archives/" title="归档">归档</a>
                    
                    <a  href="http://example.org/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">python 协程</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2017年11月26日
                        </date>
                        
                        <div class="post-meta">
                            <span>|</span>
                            
                                <span class="meta-category"><a href="http://example.org/categories/notes">notes</a></span>
                            
                        </div>
                        
                        
                        
                        <div class="post-content">
                            
<h1 id="headline-1">
协程
</h1>
<ol>
<li>
<p>
协程是一种用户态的轻量级线程，因为是非抢占式的，所以协程的调度完全由用户控制。协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到其他地方，在切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作栈则基本没有内核切换的开销，可以不加锁的访问全局变量，所以上下文的切换非常快。
</p>
</li>
<li>
<p>
协程的本质上是：allowing multiple entry points for suspending and resuming execution at certain locations.允许多个入口对程序进行挂起、继续执行等操作
</p>
</li>
</ol>
<!-- more -->
<h1 id="headline-2">
yield
</h1>
<ol>
<li>
<p>
带有 yield 的函数不再是一个普通函数，而是一个生成器 generator.
</p>
</li>
<li>
<p>
调用生成器得到一个迭代器，利用 next()或 send(msg)不断获取数据.
</p>
</li>
<li>
<p>
调用者使用 send 方法传给 yield 表达式一个值，并从下一个 yield 表达式获取一个值.
</p>
</li>
</ol>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">jump_range</span>(upper):
	  index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
	  <span style="color:#66d9ef">while</span> index <span style="color:#f92672">&lt;</span> upper:
		  jump <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span> index
		  <span style="color:#66d9ef">if</span> jump <span style="color:#f92672">is</span> None:
			  jump <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
		  index <span style="color:#f92672">+=</span> jump
  jump <span style="color:#f92672">=</span> jump_range(<span style="color:#ae81ff">5</span>)
  <span style="color:#66d9ef">print</span>(jump)
  <span style="color:#66d9ef">print</span>(jump<span style="color:#f92672">.</span>send(None))
  <span style="color:#66d9ef">print</span>(jump<span style="color:#f92672">.</span>send(<span style="color:#ae81ff">3</span>))
  <span style="color:#66d9ef">print</span>(jump<span style="color:#f92672">.</span>send(None))</code></pre></div>
</div>
<div class="src src-dot">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dot" data-lang="dot">  &lt;generator object jump_range at 0x10e283518&gt;
  0
  3
  4</code></pre></div>
</div>
<h1 id="headline-3">
yield from
</h1>
<ol>
<li>
<p>
将 yield from 视为提供了一个调用者和子生成器之间的透明的双向通道。包括从子生成器获取数据以及向子生成器传送数据。
</p>
</li>
<li>
<p>
任何使用 send()方法发给委派生产器（即外部生产器）的值被直接传递给迭代器。如果 send 值是 None，则调用迭代器 next()方法；如果不为 None，则调用迭代器的 send()方法。如果对迭代器的调用产生 StopIteration 异常，委派生产器恢复继续执行 yield from 后面的语句；若迭代器产生其他任何异常，则都传递给委派生产器。
</p>
</li>
<li>
<p>
除了 GeneratorExit 异常外的其他抛给委派生产器的异常，将会被传递到迭代器的 throw()方法。如果迭代器 throw()调用产生了 StopIteration 异常，委派生产器恢复并继续执行，其他异常则传递给委派生产器。
</p>
</li>
<li>
<p>
如果 GeneratorExit 异常被抛给委派生产器，或者委派生产器的 close()方法被调用，如果迭代器有 close()的话也将被调用。如果 close()调用产生异常，异常将传递给委派生产器。否则，委派生产器将抛出 GeneratorExit 异常。
</p>
</li>
<li>
<p>
当迭代器结束并抛出异常时，yield from 表达式的值是其 StopIteration 异常中的第一个参数。
</p>
</li>
<li>
<p>
一个生成器中的 return expr 语句将会从生成器退出并抛出 StopIteration(expr)异常。
</p>
</li>
</ol>
<h1 id="headline-4">
asyncio
</h1>
<h2 id="headline-5">
协程
</h2>
<ol>
<li>
<p>
通过 async 关键字定义一个协程（coroutine），协程也是一种对象。协程不能直接运行，需要把协程加入到事件循环（loop），由后者在适当的时候调用协程。asyncio.get_event_loop 方法可以创建一个事件循环，然后使用 run_until_complete 将协程注册到事件循环，并启动事件循环。
</p>
</li>
</ol>
<h2 id="headline-6">
task
</h2>
<ol>
<li>
<p>
协程对象不能直接运行，在注册事件循环的时候，其实是 run_until_complete 方法将协程包装成为了一个任务（task）对象。所谓 task 对象是 Future 类的子类。保存了协程运行后的状态，用于未来获取协程的结果。
</p>
</li>
</ol>
<h2 id="headline-7">
绑定回调
</h2>
<ol>
<li>
<p>
绑定回调，在 task 执行完毕的时候可以获取执行的结果，回调的最后一个参数是 future 对象，通过该对象可以获取协程返回值。如果回调需要多个参数，可以通过偏函数导入。
</p>
</li>
</ol>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">  <span style="color:#f92672">import</span> time
  <span style="color:#f92672">import</span> asyncio

  now <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> : time<span style="color:#f92672">.</span>time()

  async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_some_work</span>(x):
	  <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Waiting: &#39;</span>, x)
	  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Done after {}s&#39;</span><span style="color:#f92672">.</span>format(x)

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">callback</span>(future):
	  <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Callback: &#39;</span>, future<span style="color:#f92672">.</span>result())
   
  start <span style="color:#f92672">=</span> now()

  coroutine <span style="color:#f92672">=</span> do_some_work(<span style="color:#ae81ff">2</span>)
  loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_event_loop()
  task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>ensure_future(coroutine)
  task<span style="color:#f92672">.</span>add_done_callback(callback)
  loop<span style="color:#f92672">.</span>run_until_complete(task)

  <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;TIME: &#39;</span>, now() <span style="color:#f92672">-</span> start)</code></pre></div>
</div>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">callback</span>(t, future):
	  <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Callback:&#39;</span>, t, future<span style="color:#f92672">.</span>result())
   
  task<span style="color:#f92672">.</span>add_done_callback(functools<span style="color:#f92672">.</span>partial(callback, <span style="color:#ae81ff">2</span>))</code></pre></div>
</div>
<h1 id="headline-8">
ThreadPoolExecutor and ProcessPoolExecutor
</h1>
<p>
使用 ThreadPoolExecutor 和 ProcessPoolExecutor 来混合同步和异步代码。
</p>
<ul>
<li>
<p>
对于 CPU 限制的工作负载：使用 ProcessPoolExecutor
</p>
</li>
<li>
<p>
对于 IO 限制的工作负载：使用 ThreadPoolExecutor
</p>
<div class="src src-python">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ProcessPoolExecutor

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Handler</span>(web<span style="color:#f92672">.</span>View):
<span style="color:#66d9ef">def</span> __init__(self, request):
	super()<span style="color:#f92672">.</span>__init__(request)
	self<span style="color:#f92672">.</span>executor <span style="color:#f92672">=</span> ProcessPoolExecutor()

async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">post</span>(self):
	data <span style="color:#f92672">=</span> await self<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>post()
	thumbnail <span style="color:#f92672">=</span> await self<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>app<span style="color:#f92672">.</span>loop<span style="color:#f92672">.</span>run_in_executor(self<span style="color:#f92672">.</span>executor, resize, data[<span style="color:#e6db74">&#39;image&#39;</span>]<span style="color:#f92672">.</span>file<span style="color:#f92672">.</span>read())
	<span style="color:#66d9ef">return</span> web<span style="color:#f92672">.</span>Response(body<span style="color:#f92672">=</span>thumbnail, content_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;image/png&#39;</span>)</code></pre></div>
</div>
</li>
</ul>

                        </div>

                        


                        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/2017-06-06-python%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/">Python 虚拟环境</a></li>
        
        <li><a href="/post/2016-11-16-python-notes/">python notes</a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            <ul class="clearfix">
                                
                                <li><a href="http://example.org/tags/python">python</a></li>
                                
                            </ul>
                            
                        </div>
                    </article>
                    
    

    
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://example.org/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://example.org/post/%E4%B8%BA%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8%E6%8C%82%E8%BD%BD%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95/" title="为运行的容器挂载文件目录">为运行的容器挂载文件目录</a>
    </li>
    
    <li>
        <a href="http://example.org/post/super%E6%B2%A1%E9%82%A3%E4%B9%88%E7%AE%80%E5%8D%95/" title="super 没那么简单">super 没那么简单</a>
    </li>
    
    <li>
        <a href="http://example.org/post/postgres%E4%B8%AD%E7%9A%84%E4%BA%94%E7%A7%8D%E5%88%86%E9%A1%B5%E6%96%B9%E5%BC%8F/" title="Postgres 中的五种分页方式">Postgres 中的五种分页方式</a>
    </li>
    
    <li>
        <a href="http://example.org/post/c&#43;&#43;-ep23-if-constexpt/" title="C&#43;&#43; Ep23: constexpr if">C&#43;&#43; Ep23: constexpr if</a>
    </li>
    
    <li>
        <a href="http://example.org/post/c&#43;&#43;-ep22-fibonacci/" title="C&#43;&#43; Ep22: Fibonacci">C&#43;&#43; Ep22: Fibonacci</a>
    </li>
    
    <li>
        <a href="http://example.org/post/c&#43;&#43;-ep21-variadic-templates/" title="C&#43;&#43; Ep21: variadic Templates">C&#43;&#43; Ep21: variadic Templates</a>
    </li>
    
    <li>
        <a href="http://example.org/post/c&#43;&#43;-ep20-static-variable/" title="C&#43;&#43; Ep20: Static Variable">C&#43;&#43; Ep20: Static Variable</a>
    </li>
    
    <li>
        <a href="http://example.org/post/tweaks2/" title="Tweaks(2)">Tweaks(2)</a>
    </li>
    
    <li>
        <a href="http://example.org/post/tweaks1/" title="Tweaks(1)">Tweaks(1)</a>
    </li>
    
    <li>
        <a href="http://example.org/post/c&#43;&#43;-ep19the-concurrency-api4/" title="C&#43;&#43; Ep19:The Concurrency API(4)">C&#43;&#43; Ep19:The Concurrency API(4)</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://example.org/categories/ai/">ai(5)</a>
    </li>
    
    <li>
        <a href="http://example.org/categories/c&#43;&#43;/">c&#43;&#43;(20)</a>
    </li>
    
    <li>
        <a href="http://example.org/categories/date/">date(1)</a>
    </li>
    
    <li>
        <a href="http://example.org/categories/modern/">modern(16)</a>
    </li>
    
    <li>
        <a href="http://example.org/categories/notes/">notes(10)</a>
    </li>
    
    <li>
        <a href="http://example.org/categories/summary/">summary(5)</a>
    </li>
    
    <li>
        <a href="http://example.org/categories/weekly/">weekly(4)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="http://example.org/tags/boost/">boost</a>
    
    <a href="http://example.org/tags/c&#43;&#43;/">c&#43;&#43;</a>
    
    <a href="http://example.org/tags/constexpr/">constexpr</a>
    
    <a href="http://example.org/tags/docker/">docker</a>
    
    <a href="http://example.org/tags/etf/">etf</a>
    
    <a href="http://example.org/tags/fibonacci/">fibonacci</a>
    
    <a href="http://example.org/tags/git/">git</a>
    
    <a href="http://example.org/tags/gprof/">gprof</a>
    
    <a href="http://example.org/tags/heroku/">heroku</a>
    
    <a href="http://example.org/tags/linear/">linear</a>
    
    <a href="http://example.org/tags/linux/">linux</a>
    
    <a href="http://example.org/tags/logistic/">logistic</a>
    
    <a href="http://example.org/tags/makefile/">makefile</a>
    
    <a href="http://example.org/tags/neural/">neural</a>
    
    <a href="http://example.org/tags/postgrespaginate/">postgrespaginate</a>
    
    <a href="http://example.org/tags/protobuf/">protobuf</a>
    
    <a href="http://example.org/tags/python/">python</a>
    
    <a href="http://example.org/tags/regression/">regression</a>
    
    <a href="http://example.org/tags/regularization/">regularization</a>
    
    <a href="http://example.org/tags/spacemacs/">spacemacs</a>
    
    <a href="http://example.org/tags/static/">static</a>
    
    <a href="http://example.org/tags/template/">template</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://example.org/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2019 <a href="http://example.org/">Learning Hardy By </a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        $("pre code").parent().addClass("line-numbers")
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>






</body>
</html>
